<!DOCTYPE html>
<html>
<head>
    <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ Supabase</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial; padding: 20px; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        pre { background: #f5f5f5; padding: 10px; }
    </style>
</head>
<body>
    <h2>üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è Supabase</h2>
    
    <div id="output"></div>
    
    <button onclick="runTests()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã</button>
    
    <script>
    const SUPABASE_URL = 'https://potnqqwsaxnrrnuhoysb.supabase.co';
    
    async function runTests() {
        const output = document.getElementById('output');
        output.innerHTML = '<h3>üîç –í—ã–ø–æ–ª–Ω—è—é –ø—Ä–æ–≤–µ—Ä–∫–∏...</h3>';
        
        // 1. –ó–∞–ø—Ä–æ—Å–∏–º –∫–ª—é—á —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const userKey = prompt(
            '–í–≤–µ–¥–∏—Ç–µ ANON PUBLIC –∫–ª—é—á –∏–∑ Supabase Dashboard:\n' +
            '(Dashboard ‚Üí Settings ‚Üí API ‚Üí "anon public")',
            localStorage.getItem('test_supabase_key') || ''
        );
        
        if (!userKey) return;
        localStorage.setItem('test_supabase_key', userKey);
        
        // 2. –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç
        output.innerHTML += `<p>1. –°–æ–∑–¥–∞—é –∫–ª–∏–µ–Ω—Ç —Å –∫–ª—é—á–æ–º –¥–ª–∏–Ω–æ–π ${userKey.length}...</p>`;
        
        let supabase;
        try {
            supabase = window.supabase.createClient(SUPABASE_URL, userKey);
            output.innerHTML += '<p class="success">‚úÖ –ö–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω</p>';
        } catch (e) {
            output.innerHTML += `<p class="error">‚ùå –û—à–∏–±–∫–∞: ${e.message}</p>`;
            return;
        }
        
        // 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–±–ª–∏—Ü—É users
        output.innerHTML += '<p>2. –ü—Ä–æ–≤–µ—Ä—è—é —Ç–∞–±–ª–∏—Ü—É users...</p>';
        try {
            const { data, error } = await supabase
                .from('users')
                .select('email, role')
                .limit(2);
            
            if (error) {
                output.innerHTML += `<p class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</p>`;
                
                if (error.message.includes('relation')) {
                    output.innerHTML += '<p class="warning">üìù –°–æ–≤–µ—Ç: –°–æ–∑–¥–∞–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É users —á–µ—Ä–µ–∑ SQL Editor</p>';
                }
            } else {
                output.innerHTML += `<p class="success">‚úÖ –¢–∞–±–ª–∏—Ü–∞ –Ω–∞–π–¥–µ–Ω–∞. –ó–∞–ø–∏—Å–µ–π: ${data.length}</p>`;
                if (data.length > 0) {
                    output.innerHTML += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                }
            }
        } catch (e) {
            output.innerHTML += `<p class="error">‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: ${e.message}</p>`;
        }
        
        // 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
        output.innerHTML += '<p>3. –¢–µ—Å—Ç–∏—Ä—É—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é...</p>';
        try {
            const { data, error } = await supabase
                .from('users')
                .select('*')
                .eq('email', 'student@school.ru')
                .eq('password', '123')
                .single();
            
            if (error || !data) {
                output.innerHTML += `<p class="warning">‚ö†Ô∏è –¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω</p>`;
                output.innerHTML += `<p>–î–æ–±–∞–≤—å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è SQL:</p>
                <pre>INSERT INTO users (email, password, full_name, role) 
VALUES ('student@school.ru', '123', '–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤', 'student');</pre>`;
            } else {
                output.innerHTML += `<p class="success">‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${data.full_name}</p>`;
            }
        } catch (e) {
            output.innerHTML += `<p class="error">‚ùå –û—à–∏–±–∫–∞: ${e.message}</p>`;
        }
        
        // 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º CORS
        output.innerHTML += '<p>4. –ü—Ä–æ–≤–µ—Ä—è—é CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏...</p>';
        try {
            const response = await fetch(`${SUPABASE_URL}/rest/v1/`, {
                headers: { 'apikey': userKey }
            });
            output.innerHTML += `<p>Status: ${response.status} ${response.statusText}</p>`;
        } catch (e) {
            output.innerHTML += `<p class="warning">‚ö†Ô∏è CORS –æ—à–∏–±–∫–∞: ${e.message}</p>`;
            output.innerHTML += `<p>–î–æ–±–∞–≤—å—Ç–µ –¥–æ–º–µ–Ω –≤ Supabase Dashboard ‚Üí Settings ‚Üí API ‚Üí CORS Origins:</p>
            <ul>
                <li>https://petr-susloparov.github.io</li>
                <li>http://localhost</li>
            </ul>`;
        }
    }
    </script>
</body>
</html>